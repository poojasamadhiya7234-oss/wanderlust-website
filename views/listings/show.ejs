<!-- <% layout("/layouts/boilerplate")%>
<body>
    

    <h3>Listing Detailes:</h3>
    <ul>
<li><%=listingdata.title %></li>
<li><%=listingdata.description %></li>
<li>&#8377; <%=listingdata.price.toLocaleString("en-IN") %></li>
<li><%=listingdata.location %></li>
<li><%=listingdata.country %></li>



 </ul>
 <a href="/listings/<%=listingdata._id%>/edit">Edit this Listing</a>
<br/><br/>
<form method="POST" action="/listings/<%=listingdata._id%>?_method=DELETE">
    <button>Delete this listing</button>
</form>

</body> -->



  


  

  
    
  




  
    


 <% layout("/layouts/boilerplate") %>
 
  

 


<div class="container my-5">
  <div class="card mx-auto shadow" style="max-width: 600px;">

    <!-- Image -->
     <img src="<%= listingdata.image.url  %>" 
         class="card-img-top" alt="<%= listingdata.title %>" 
         style="height: 300px; object-fit: cover;">

    <div class="card-body">
      <h3 class="card-title mb-4 text-center" style="color: #ff5a5f;">Listing Details</h3>

      <ul class="list-group list-group-flush mb-4">
        <li class="list-group-item"><strong>Title:</strong> <%= listingdata.title %></li>
        <li class="list-group-item"><strong>Ownedby:</strong> <%= listingdata.owner.username %></li>
        <li class="list-group-item"><strong>Description:</strong> <%= listingdata.description %></li>
        <li class="list-group-item"><strong>Price:</strong> &#8377; <%= listingdata.price.toLocaleString("en-IN") %></li>
        <li class="list-group-item"><strong>Location:</strong> <%= listingdata.location %></li>
        <li class="list-group-item"><strong>Country:</strong> <%= listingdata.country %></li>
      </ul>



       <% if(currUser && listingdata.owner._id.equals(currUser._id)){%> 
      <!-- Buttons -->
       <div class="d-flex justify-content-between">
        <a href="/listings/<%= listingdata._id %>/edit" class="btn btn-danger">Edit this Listing</a>

        <form method="POST" action="/listings/<%= listingdata._id %>?_method=DELETE" 
              onsubmit="return confirm('Are you sure you want to delete this listing?');">
          <button type="submit" class="btn btn-danger">Delete this Listing</button>
        </form>
      </div>

      <% } %> 
   

       <div class="col-10 offset-1 mb-5 mt-4">
    <hr class="my-4" />
    <% if(currUser){%>
    <h4 class="text-center mb-4" style="color:#ff5a5f; font-weight:600;">Leave a Review</h4>

    <form action="/listings/<%= listingdata._id %>/reviews" method="POST" novalidate class="needs-validation bg-light p-4 rounded shadow-sm">

       
  <div class="mb-4">
    <label for="rating" class="form-label fw-semibold">Rating</label>
      <fieldset class="starability-basic">
        
 
  <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
  <label for="first-rate1" title="Terrible">1 star</label>
  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
  <label for="first-rate2" title="Not good">2 stars</label>
  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
  <label for="first-rate3" title="Average">3 stars</label>
  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
  <label for="first-rate4" title="Very good">4 stars</label>
  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
  <label for="first-rate5" title="Amazing">5 stars</label>
</fieldset>
</div>



      <div class="mb-4">
        <label for="comment" class="form-label fw-semibold">Comment</label>
        <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control shadow-sm" placeholder="Write your honest feedback..." required></textarea>
        <div class="invalid-feedback">Please add some comment for review</div>
      </div>

      <div class="text-center">
        <button class="btn btn-primary px-5" style="background-color:#ff5a5f; border:none;">Submit</button>
      </div>

    </form>
  <%}%>

    <hr class="my-5"/>

    <h4 class="text-center mb-4" style="color:#ff5a5f; font-weight:600;">All Reviews</h4>

    <div class="row justify-content-center">
      <% if(listingdata.reviews.length === 0) { %>
        <p class="text-center text-muted">No reviews yet. Be the first to review!</p>
      <% } else { %>
        <% for(let review of listingdata.reviews) { %>
          <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">@<%=review.author.username %></h6>
                <p class="card-text"><%= review.comment %></p>
                
                  
<p class="starability-result card-text" data-rating="<%= review.rating %>"></p>

          
                <form method="POST" action="/listings/<%= listingdata._id %>/reviews/<%= review._id %>?_method=DELETE" onsubmit="return confirm('Delete this review?');">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            </div>
          </div>
        <% } %>
      <% } %>
    </div>
  </div> 
  

</div >



<div  style="max-width: 700px; "  >
            <h3 class="mb-3" style="color:#ff5a5f; font-weight:800;">Where you'll be</h3>

            <div id="map" class="border rounded mb-5" style="height:300px; width: 100%;   box-shadow: 0 2px 10px rgba(0,0,0,0.3)"></div>

      
      
</div>
</div> 

</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    async function loadMap() {
        let location = "<%= listingdata.location %>";

        let url = `https://nominatim.openstreetmap.org/search?format=json&q=${location}`;
        let res = await fetch(url);
        let data = await res.json();

        let lat = data[0].lat;
        let lon = data[0].lon;

        var map = L.map('map').setView([lat, lon], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        L.marker([lat, lon]).addTo(map).bindPopup(location).openPopup();
    }

    loadMap();
</script>